{% comment %}
  Live FOMO Counter - Shopify Snippet
  
  Usage: {% render 'live-fomo-counter' %}
  
  Customization:
  {% render 'live-fomo-counter',
    initial_viewers: 53,
    initial_stock: 30,
    min_viewers: 35,
    max_viewers: 89,
    min_stock: 5,
    viewer_update_interval: 3000,
    stock_update_interval: 8000
  %}
{% endcomment %}

{% assign unique_id = section.id | default: 'default' | append: '-' | append: block.id | default: 'snippet' %}

{% comment %} Default Settings {% endcomment %}
{% assign initial_viewers = initial_viewers | default: 53 %}
{% assign initial_stock = initial_stock | default: 30 %}
{% assign min_viewers = min_viewers | default: 35 %}
{% assign max_viewers = max_viewers | default: 89 %}
{% assign min_stock = min_stock | default: 5 %}
{% assign viewer_update_interval = viewer_update_interval | default: 3000 %}
{% assign stock_update_interval = stock_update_interval | default: 8000 %}

{% assign background_color = background_color | default: "#FFFFFF" %}
{% assign border_width = border_width | default: 1 %}
{% assign border_color = border_color | default: "#E0E0E0" %}
{% assign hover_border_color = hover_border_color | default: "#CCCCCC" %}
{% assign border_radius = border_radius | default: 0 %}
{% assign shadow_horizontal = shadow_horizontal | default: 0 %}
{% assign shadow_vertical = shadow_vertical | default: 4 %}
{% assign shadow_blur = shadow_blur | default: 8 %}
{% assign shadow_opacity = shadow_opacity | default: 0 %}
{% assign text_color = text_color | default: "#374151" %}
{% assign accent_color = accent_color | default: "#10B981" %}
{% assign stock_bg = stock_bg | default: "#FEF3C7" %}
{% assign stock_text = stock_text | default: "#92400E" %}
{% assign bar_bg = bar_bg | default: "#E5E7EB" %}
{% assign bar_fill_high = bar_fill_high | default: "#3B82F6" %}
{% assign bar_fill_medium = bar_fill_medium | default: "#F97316" %}
{% assign bar_fill_low = bar_fill_low | default: "#EF4444" %}

{% style %}
  .fomo-counter-{{ unique_id }} {
    background: {{ background_color }};
    border: {{ border_width }}px solid {{ border_color }};
    border-radius: {{ border_radius }}px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: {{ shadow_horizontal }}px {{ shadow_vertical }}px {{ shadow_blur }}px rgba(0, 0, 0, {{ shadow_opacity | divided_by: 100.0 }});
    transition: border-color 0.3s ease;
  }

  .fomo-counter-{{ unique_id }}:hover {
    border-color: {{ hover_border_color }};
  }

  .fomo-counter__viewers-{{ unique_id }} {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: {{ border_width }}px solid {{ border_color }};
  }

  .fomo-counter__eye-icon-{{ unique_id }} {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    position: relative;
  }

  .fomo-counter__eye-icon-{{ unique_id }} svg {
    width: 100%;
    height: 100%;
    fill: {{ accent_color }};
  }

  .fomo-counter__pulse-dot-{{ unique_id }} {
    width: 8px;
    height: 8px;
    background: {{ accent_color }};
    border-radius: 50%;
    position: relative;
    flex-shrink: 0;
  }

  .fomo-counter__pulse-dot-{{ unique_id }}::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    height: 100%;
    background: {{ accent_color }};
    border-radius: 50%;
    animation: pulse-ring-{{ unique_id }} 2s ease-out infinite;
  }

  @keyframes pulse-ring-{{ unique_id }} {
    0% {
      transform: translate(-50%, -50%) scale(1);
      opacity: 0.8;
    }
    100% {
      transform: translate(-50%, -50%) scale(3);
      opacity: 0;
    }
  }

  .fomo-counter__viewers-text-{{ unique_id }} {
    color: {{ text_color }};
    font-size: 14px;
    font-weight: 500;
    margin: 0;
    line-height: 1.4;
  }

  .fomo-counter__viewers-number-{{ unique_id }} {
    font-weight: 700;
    color: {{ accent_color }};
    display: inline-block;
    min-width: 25px;
  }

  .fomo-counter__stock-section-{{ unique_id }} {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .fomo-counter__stock-header-{{ unique_id }} {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .fomo-counter__stock-label-{{ unique_id }} {
    font-size: 13px;
    font-weight: 600;
    color: {{ stock_text }};
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .fomo-counter__stock-count-{{ unique_id }} {
    background: {{ stock_bg }};
    color: {{ stock_text }};
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .fomo-counter__stock-number-{{ unique_id }} {
    font-size: 16px;
  }

  .fomo-counter__progress-container-{{ unique_id }} {
    position: relative;
  }

  .fomo-counter__progress-bar-{{ unique_id }} {
    height: 8px;
    background: {{ bar_bg }};
    border-radius: 4px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .fomo-counter__progress-fill-{{ unique_id }} {
    height: 100%;
    background: {{ bar_fill_high }};
    border-radius: 4px;
    transition: all 0.8s ease-out;
    position: relative;
    overflow: hidden;
  }

  .fomo-counter__progress-fill-{{ unique_id }}::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.4) 50%, transparent 100%);
    animation: shimmer-{{ unique_id }} 2s infinite;
  }

  @keyframes shimmer-{{ unique_id }} {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  .fomo-counter__updating-{{ unique_id }} {
    animation: update-bounce-{{ unique_id }} 0.4s ease;
  }

  @keyframes update-bounce-{{ unique_id }} {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.08); }
  }

  /* Responsive Design */
  @media screen and (min-width: 640px) {
    .fomo-counter-{{ unique_id }} {
      padding: 24px;
    }

    .fomo-counter__viewers-{{ unique_id }} {
      justify-content: center;
      margin-bottom: 20px;
      padding-bottom: 20px;
    }

    .fomo-counter__viewers-text-{{ unique_id }} {
      font-size: 15px;
    }

    .fomo-counter__stock-label-{{ unique_id }} {
      font-size: 14px;
    }

    .fomo-counter__stock-count-{{ unique_id }} {
      font-size: 14px;
      padding: 5px 14px;
    }

    .fomo-counter__progress-bar-{{ unique_id }} {
      height: 10px;
    }
  }

  @media screen and (min-width: 990px) {
    .fomo-counter-{{ unique_id }} {
      max-width: 600px;
      margin: 20px auto;
    }
  }
{% endstyle %}

<div class="fomo-counter-{{ unique_id }}" id="fomo-counter-{{ unique_id }}">
  <!-- Viewers Section -->
  <div class="fomo-counter__viewers-{{ unique_id }}">
    <div class="fomo-counter__pulse-dot-{{ unique_id }}"></div>
    <p class="fomo-counter__viewers-text-{{ unique_id }}">
      <span class="fomo-counter__viewers-number-{{ unique_id }}" data-viewers="{{ initial_viewers }}">{{ initial_viewers }}</span> people are viewing this right now
    </p>
  </div>

  <!-- Stock Section -->
  <div class="fomo-counter__stock-section-{{ unique_id }}">
    <div class="fomo-counter__stock-header-{{ unique_id }}">
      <p class="fomo-counter__stock-label-{{ unique_id }}">Availability</p>
      <div class="fomo-counter__stock-count-{{ unique_id }}">
        <span class="fomo-counter__stock-number-{{ unique_id }}" data-stock="{{ initial_stock }}">{{ initial_stock }}</span>
        <span>units left</span>
      </div>
    </div>
    
    <div class="fomo-counter__progress-container-{{ unique_id }}">
      <div class="fomo-counter__progress-bar-{{ unique_id }}">
        <div class="fomo-counter__progress-fill-{{ unique_id }}" data-progress style="width: 100%;"></div>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const uniqueId = '{{ unique_id }}';
    const container = document.getElementById('fomo-counter-' + uniqueId);
    
    if (!container) return;

    const viewersElement = container.querySelector('[data-viewers]');
    const stockElement = container.querySelector('[data-stock]');
    const progressBar = container.querySelector('[data-progress]');

    let currentViewers = {{ initial_viewers }};
    let currentStock = {{ initial_stock }};
    const initialStock = {{ initial_stock }};

    const config = {
      minViewers: {{ min_viewers }},
      maxViewers: {{ max_viewers }},
      minStock: {{ min_stock }},
      viewerUpdateInterval: {{ viewer_update_interval }},
      stockUpdateInterval: {{ stock_update_interval }}
    };

    function randomBetween(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function updateProgressBar() {
      const percentage = (currentStock / initialStock) * 100;
      progressBar.style.width = percentage + '%';
      
      // Change color based on stock level
      if (percentage <= 25) {
        progressBar.style.background = '{{ bar_fill_low }}';
      } else if (percentage <= 50) {
        progressBar.style.background = '{{ bar_fill_medium }}';
      } else {
        progressBar.style.background = '{{ bar_fill_high }}';
      }
    }

    function updateViewers() {
      const change = randomBetween(-2, 5);
      let newViewers = currentViewers + change;

      if (newViewers > config.maxViewers) newViewers = config.maxViewers;
      if (newViewers < config.minViewers) newViewers = config.minViewers;

      if (newViewers !== currentViewers) {
        currentViewers = newViewers;
        viewersElement.classList.add('fomo-counter__updating-{{ unique_id }}');
        viewersElement.textContent = currentViewers;

        setTimeout(() => {
          viewersElement.classList.remove('fomo-counter__updating-{{ unique_id }}');
        }, 400);
      }
    }

    function updateStock() {
      if (currentStock > config.minStock) {
        const decrease = randomBetween(1, 2);
        currentStock = Math.max(config.minStock, currentStock - decrease);

        stockElement.classList.add('fomo-counter__updating-{{ unique_id }}');
        stockElement.textContent = currentStock;
        
        updateProgressBar();

        setTimeout(() => {
          stockElement.classList.remove('fomo-counter__updating-{{ unique_id }}');
        }, 400);
      }
    }

    // Initialize
    updateProgressBar();

    // Start intervals
    const viewerInterval = setInterval(updateViewers, config.viewerUpdateInterval);
    const stockInterval = setInterval(updateStock, config.stockUpdateInterval);

    // Add variation after 1 minute
    setTimeout(() => {
      clearInterval(viewerInterval);
      setInterval(updateViewers, config.viewerUpdateInterval + randomBetween(-500, 500));
    }, 60000);

    // Cleanup
    window.addEventListener('beforeunload', () => {
      clearInterval(viewerInterval);
      clearInterval(stockInterval);
    });

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        clearInterval(viewerInterval);
        clearInterval(stockInterval);
      }
    });
  })();
</script>