{% comment %}
  Live FOMO Counter - Shopify Snippet
  
  Usage: {% render 'live-fomo-counter' %}
  
  Customization:
  {% render 'live-fomo-counter',
    initial_viewers: 53,
    initial_stock: 30,
    min_viewers: 35,
    max_viewers: 89,
    min_stock: 5,
    viewer_update_interval: 3000,
    stock_update_interval: 8000
  %}
{% endcomment %}

{% assign unique_id = section.id | default: 'default' | append: '-' | append: block.id | default: 'snippet' %}

{% comment %} Default Settings {% endcomment %}
{% assign initial_viewers = initial_viewers | default: 53 %}
{% assign initial_stock = initial_stock | default: 30 %}
{% assign min_viewers = min_viewers | default: 35 %}
{% assign max_viewers = max_viewers | default: 89 %}
{% assign min_stock = min_stock | default: 5 %}
{% assign viewer_update_interval = viewer_update_interval | default: 3000 %}
{% assign stock_update_interval = stock_update_interval | default: 8000 %}

{% assign background_color = background_color | default: "#FFF3CD" %}
{% assign border_color = border_color | default: "#FFD700" %}
{% assign text_color = text_color | default: "#856404" %}
{% assign icon_color = icon_color | default: "#FF6B6B" %}
{% assign stock_color = stock_color | default: "#DC3545" %}
{% assign pulse_color = pulse_color | default: "#FF6B6B" %}

{% style %}
  .fomo-counter-{{ unique_id }} {
    background: {{ background_color }};
    border: 2px solid {{ border_color }};
    border-radius: 8px;
    padding: 12px 16px;
    margin: 16px 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
    position: relative;
    overflow: hidden;
  }

  .fomo-counter-{{ unique_id }}::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shimmer-{{ unique_id }} 3s infinite;
  }

  @keyframes shimmer-{{ unique_id }} {
    0% { left: -100%; }
    100% { left: 100%; }
  }

  .fomo-counter__row-{{ unique_id }} {
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
    z-index: 1;
  }

  .fomo-counter__icon-{{ unique_id }} {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    position: relative;
  }

  .fomo-counter__icon-{{ unique_id }} svg {
    width: 100%;
    height: 100%;
    fill: {{ icon_color }};
  }

  .fomo-counter__pulse-{{ unique_id }} {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: {{ pulse_color }};
    opacity: 0.6;
    animation: pulse-{{ unique_id }} 2s ease-out infinite;
  }

  @keyframes pulse-{{ unique_id }} {
    0% {
      transform: translate(-50%, -50%) scale(1);
      opacity: 0.6;
    }
    100% {
      transform: translate(-50%, -50%) scale(2);
      opacity: 0;
    }
  }

  .fomo-counter__text-{{ unique_id }} {
    color: {{ text_color }};
    font-size: 14px;
    font-weight: 600;
    margin: 0;
    line-height: 1.4;
  }

  .fomo-counter__number-{{ unique_id }} {
    font-weight: 700;
    font-size: 16px;
    display: inline-block;
    min-width: 30px;
    text-align: center;
  }

  .fomo-counter__stock-{{ unique_id }} {
    color: {{ stock_color }};
    font-weight: 700;
  }

  .fomo-counter__updating-{{ unique_id }} {
    animation: update-flash-{{ unique_id }} 0.5s ease;
  }

  @keyframes update-flash-{{ unique_id }} {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }

  @media screen and (min-width: 749px) {
    .fomo-counter-{{ unique_id }} {
      flex-direction: row;
      justify-content: center;
      gap: 24px;
      padding: 14px 20px;
    }

    .fomo-counter__text-{{ unique_id }} {
      font-size: 15px;
    }

    .fomo-counter__number-{{ unique_id }} {
      font-size: 17px;
    }
  }
{% endstyle %}

<div class="fomo-counter-{{ unique_id }}" id="fomo-counter-{{ unique_id }}">
  <div class="fomo-counter__row-{{ unique_id }}">
    <div class="fomo-counter__icon-{{ unique_id }}">
      <div class="fomo-counter__pulse-{{ unique_id }}"></div>
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
      </svg>
    </div>
    <p class="fomo-counter__text-{{ unique_id }}">
      <span class="fomo-counter__number-{{ unique_id }}" data-viewers="{{ initial_viewers }}">{{ initial_viewers }}</span> people are viewing this right now
    </p>
  </div>

  <div class="fomo-counter__row-{{ unique_id }}">
    <div class="fomo-counter__icon-{{ unique_id }}">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
      </svg>
    </div>
    <p class="fomo-counter__text-{{ unique_id }}">
      Only <span class="fomo-counter__number-{{ unique_id }} fomo-counter__stock-{{ unique_id }}" data-stock="{{ initial_stock }}">{{ initial_stock }}</span> left in stock!
    </p>
  </div>
</div>

<script>
  (function() {
    const uniqueId = '{{ unique_id }}';
    const container = document.getElementById('fomo-counter-' + uniqueId);
    
    if (!container) return;

    const viewersElement = container.querySelector('[data-viewers]');
    const stockElement = container.querySelector('[data-stock]');

    let currentViewers = {{ initial_viewers }};
    let currentStock = {{ initial_stock }};

    const config = {
      minViewers: {{ min_viewers }},
      maxViewers: {{ max_viewers }},
      minStock: {{ min_stock }},
      viewerUpdateInterval: {{ viewer_update_interval }},
      stockUpdateInterval: {{ stock_update_interval }}
    };

    // Generate random number between min and max
    function randomBetween(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // Update viewers with smooth animation
    function updateViewers() {
      const change = randomBetween(-2, 5); // More likely to increase
      let newViewers = currentViewers + change;

      // Keep within bounds
      if (newViewers > config.maxViewers) newViewers = config.maxViewers;
      if (newViewers < config.minViewers) newViewers = config.minViewers;

      if (newViewers !== currentViewers) {
        currentViewers = newViewers;
        viewersElement.classList.add('fomo-counter__updating-{{ unique_id }}');
        viewersElement.textContent = currentViewers;

        setTimeout(() => {
          viewersElement.classList.remove('fomo-counter__updating-{{ unique_id }}');
        }, 500);
      }
    }

    // Update stock (always decreasing)
    function updateStock() {
      if (currentStock > config.minStock) {
        const decrease = randomBetween(1, 2);
        currentStock = Math.max(config.minStock, currentStock - decrease);

        stockElement.classList.add('fomo-counter__updating-{{ unique_id }}');
        stockElement.textContent = currentStock;

        setTimeout(() => {
          stockElement.classList.remove('fomo-counter__updating-{{ unique_id }}');
        }, 500);

        // Create extra urgency when stock is low
        if (currentStock <= 10) {
          container.style.animation = 'none';
          setTimeout(() => {
            container.style.animation = '';
          }, 10);
        }
      }
    }

    // Start intervals
    const viewerInterval = setInterval(updateViewers, config.viewerUpdateInterval);
    const stockInterval = setInterval(updateStock, config.stockUpdateInterval);

    // Add slight variation to intervals to make it feel more natural
    setTimeout(() => {
      clearInterval(viewerInterval);
      setInterval(updateViewers, config.viewerUpdateInterval + randomBetween(-500, 500));
    }, 60000); // After 1 minute, add variation

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      clearInterval(viewerInterval);
      clearInterval(stockInterval);
    });

    // Pause updates when page is not visible
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        clearInterval(viewerInterval);
        clearInterval(stockInterval);
      }
    });
  })();
</script>