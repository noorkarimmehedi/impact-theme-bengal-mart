{% comment %}
  Compact Home & Kitchen Live Counter - Shopify Snippet (2-Line Design)
  
  Usage: {% render 'home-kitchen-live-counter-compact' %}
  
  Customization:
  {% render 'home-kitchen-live-counter-compact',
    initial_viewers: 127,
    initial_stock: 39,
    min_viewers: 85,
    max_viewers: 180,
    min_stock: 0
  %}
{% endcomment %}

{% assign unique_id = section.id | default: 'default' | append: '-' | append: block.id | default: 'snippet' %}

{% comment %} Generate random stock based on product ID {% endcomment %}
{% if initial_stock == blank or initial_stock == null %}
  {% assign product_id_num = product.id | default: 0 %}
  {% assign seed = product_id_num | modulo: 11 %}
  {% assign initial_stock = seed | plus: 35 %}
{% endif %}

{% comment %} Default Settings {% endcomment %}
{% assign initial_viewers = initial_viewers | default: 127 %}
{% assign initial_stock = initial_stock | default: 39 %}
{% assign min_viewers = min_viewers | default: 85 %}
{% assign max_viewers = max_viewers | default: 180 %}
{% assign min_stock = min_stock | default: 0 %}

{% style %}
  .kitchen-counter-compact-{{ unique_id }} {
    background: linear-gradient(135deg, #FFFFFF 0%, #FFF5F5 100%);
    border: 1.5px solid #000000;
    border-radius: 4px;
    padding: 6px 10px;
    margin: 6px 0;
    box-shadow: 0 0 15px rgba(213, 0, 0, 0.12);
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .kitchen-counter-compact__row-{{ unique_id }} {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    width: 100%;
  }
  
  .kitchen-counter-compact__row-{{ unique_id }}:first-child {
    flex-wrap: nowrap;
  }

  .kitchen-counter-compact__live-badge-{{ unique_id }} {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    background: #7900FD;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    white-space: nowrap;
  }

  .kitchen-counter-compact__live-dot-{{ unique_id }} {
    width: 4px;
    height: 4px;
    background: white;
    border-radius: 50%;
    animation: live-pulse-compact-{{ unique_id }} 2s ease-in-out infinite;
  }

  @keyframes live-pulse-compact-{{ unique_id }} {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  .kitchen-counter-compact__viewers-{{ unique_id }} {
    display: flex;
    align-items: center;
    gap: 5px;
    flex: 1;
    min-width: 0;
    justify-content: flex-end;
  }

  .kitchen-counter-compact__eye-icon-{{ unique_id }} {
    width: 14px;
    height: 14px;
    flex-shrink: 0;
  }

  .kitchen-counter-compact__eye-icon-{{ unique_id }} svg {
    width: 100%;
    height: 100%;
    fill: #7900FD;
  }

  .kitchen-counter-compact__viewers-text-{{ unique_id }} {
    color: #1F2937;
    font-size: 11px;
    font-weight: 600;
    margin: 0;
    line-height: 1;
    white-space: nowrap;
  }

  .kitchen-counter-compact__viewers-number-{{ unique_id }} {
    font-weight: 800;
    color: #7900FD;
    font-size: 12px;
  }

  .kitchen-counter-compact__stock-wrapper-{{ unique_id }} {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  .kitchen-counter-compact__stock-label-{{ unique_id }} {
    font-size: 10px;
    font-weight: 700;
    color: #7900FD;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    display: flex;
    align-items: center;
    gap: 3px;
    white-space: nowrap;
  }

  .kitchen-counter-compact__stock-icon-{{ unique_id }} {
    width: 12px;
    height: 12px;
  }

  .kitchen-counter-compact__stock-count-{{ unique_id }} {
    background: linear-gradient(135deg, #7900FD 0%, #7900FD 100%);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 800;
    display: inline-flex;
    align-items: center;
    gap: 3px;
    white-space: nowrap;
  }

  .kitchen-counter-compact__stock-number-{{ unique_id }} {
    font-size: 12px;
    min-width: 16px;
    text-align: center;
  }

  .kitchen-counter-compact__progress-container-{{ unique_id }} {
    flex: 1;
    min-width: 80px;
    max-width: 200px;
  }

  .kitchen-counter-compact__progress-bar-{{ unique_id }} {
    height: 5px;
    background: linear-gradient(90deg, #FFE0E0 0%, #FFF5F5 100%);
    border-radius: 3px;
    overflow: hidden;
    position: relative;
    border: 1px solid #FFD0D0;
  }

  .kitchen-counter-compact__progress-fill-{{ unique_id }} {
    height: 100%;
    background: linear-gradient(90deg, #7900FD 0%, #7900FD 100%);
    border-radius: 3px;
    transition: width 0.5s ease-out;
  }

  .kitchen-counter-compact__updating-{{ unique_id }} {
    animation: update-pop-compact-{{ unique_id }} 0.3s ease;
  }

  @keyframes update-pop-compact-{{ unique_id }} {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.08); }
  }

  /* Responsive Design */
  @media screen and (min-width: 640px) {
    .kitchen-counter-compact-{{ unique_id }} {
      padding: 7px 12px;
    }

    .kitchen-counter-compact__row-{{ unique_id }} {
      gap: 12px;
    }

    .kitchen-counter-compact__viewers-text-{{ unique_id }} {
      font-size: 12px;
    }

    .kitchen-counter-compact__stock-label-{{ unique_id }} {
      font-size: 11px;
    }

    .kitchen-counter-compact__progress-bar-{{ unique_id }} {
      height: 6px;
    }

    .kitchen-counter-compact__progress-container-{{ unique_id }} {
      max-width: 250px;
    }
  }

  /* Reduce animations on mobile devices */
  @media (prefers-reduced-motion: reduce) {
    .kitchen-counter-compact__live-dot-{{ unique_id }},
    .kitchen-counter-compact__updating-{{ unique_id }} {
      animation: none;
    }
  }
{% endstyle %}

<div class="kitchen-counter-compact-{{ unique_id }}" id="kitchen-counter-compact-{{ unique_id }}">
  <!-- First Row: Live Badge + Viewers -->
  <div class="kitchen-counter-compact__row-{{ unique_id }}">
    <div class="kitchen-counter-compact__live-badge-{{ unique_id }}">
      <div class="kitchen-counter-compact__live-dot-{{ unique_id }}"></div>
      <span>Live</span>
    </div>
    
    <div class="kitchen-counter-compact__viewers-{{ unique_id }}">
      <div class="kitchen-counter-compact__eye-icon-{{ unique_id }}">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
        </svg>
      </div>
      <p class="kitchen-counter-compact__viewers-text-{{ unique_id }}">
        <span class="kitchen-counter-compact__viewers-number-{{ unique_id }}" data-viewers="{{ initial_viewers }}">{{ initial_viewers }}</span> viewing
      </p>
    </div>
  </div>

  <!-- Second Row: Stock Info + Progress Bar -->
  <div class="kitchen-counter-compact__row-{{ unique_id }}">
    <div class="kitchen-counter-compact__stock-wrapper-{{ unique_id }}">
      <p class="kitchen-counter-compact__stock-label-{{ unique_id }}">
        <svg class="kitchen-counter-compact__stock-icon-{{ unique_id }}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#7900FD">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
        Stock
      </p>
      <div class="kitchen-counter-compact__stock-count-{{ unique_id }}">
        <span class="kitchen-counter-compact__stock-number-{{ unique_id }}" data-stock="{{ initial_stock }}">{{ initial_stock }}</span>
        <span>units</span>
      </div>
    </div>

    <div class="kitchen-counter-compact__progress-container-{{ unique_id }}">
      <div class="kitchen-counter-compact__progress-bar-{{ unique_id }}">
        <div class="kitchen-counter-compact__progress-fill-{{ unique_id }}" data-progress style="width: 100%;"></div>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const uniqueId = '{{ unique_id }}';
    const container = document.getElementById('kitchen-counter-compact-' + uniqueId);
    
    if (!container) return;

    const viewersElement = container.querySelector('[data-viewers]');
    const stockElement = container.querySelector('[data-stock]');
    const progressBar = container.querySelector('[data-progress]');

    let currentViewers = {{ initial_viewers }};
    let currentStock = {{ initial_stock }};
    const initialStock = {{ initial_stock }};

    const config = {
      minViewers: {{ min_viewers }},
      maxViewers: {{ max_viewers }},
      minStock: {{ min_stock }},
      viewerUpdateInterval: 8000,
      stockUpdateInterval: 6000
    };

    let viewerInterval = null;
    let stockInterval = null;
    let isTabActive = true;

    function randomBetween(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function updateProgressBar() {
      const percentage = (currentStock / initialStock) * 100;
      progressBar.style.width = percentage + '%';
    }

    function updateViewers() {
      if (!isTabActive) return;
      
      const change = randomBetween(-3, 5);
      let newViewers = currentViewers + change;

      newViewers = Math.max(config.minViewers, Math.min(config.maxViewers, newViewers));

      if (newViewers !== currentViewers) {
        currentViewers = newViewers;
        viewersElement.classList.add('kitchen-counter-compact__updating-{{ unique_id }}');
        viewersElement.textContent = currentViewers;

        setTimeout(() => {
          viewersElement.classList.remove('kitchen-counter-compact__updating-{{ unique_id }}');
        }, 300);
      }
    }

    function updateStock() {
      if (!isTabActive) return;
      
      if (currentStock > config.minStock) {
        currentStock = Math.max(config.minStock, currentStock - 1);

        stockElement.classList.add('kitchen-counter-compact__updating-{{ unique_id }}');
        stockElement.textContent = currentStock;
        
        updateProgressBar();

        setTimeout(() => {
          stockElement.classList.remove('kitchen-counter-compact__updating-{{ unique_id }}');
        }, 300);
      }
    }

    function startIntervals() {
      if (viewerInterval) clearInterval(viewerInterval);
      if (stockInterval) clearInterval(stockInterval);
      
      viewerInterval = setInterval(updateViewers, config.viewerUpdateInterval);
      stockInterval = setInterval(updateStock, config.stockUpdateInterval);
    }

    function stopIntervals() {
      if (viewerInterval) clearInterval(viewerInterval);
      if (stockInterval) clearInterval(stockInterval);
      viewerInterval = null;
      stockInterval = null;
    }

    // Initialize
    updateProgressBar();
    
    // Drop from 39 to 35 in first 6 seconds (4 units)
    const initialDropInterval = 1500;
    let dropCount = 0;
    const maxInitialDrops = 4;
    
    const initialDropTimer = setInterval(() => {
      if (dropCount < maxInitialDrops && currentStock > config.minStock) {
        currentStock--;
        dropCount++;
        
        stockElement.classList.add('kitchen-counter-compact__updating-{{ unique_id }}');
        stockElement.textContent = currentStock;
        updateProgressBar();
        
        setTimeout(() => {
          stockElement.classList.remove('kitchen-counter-compact__updating-{{ unique_id }}');
        }, 300);
        
        if (dropCount >= maxInitialDrops) {
          clearInterval(initialDropTimer);
          startIntervals();
        }
      }
    }, initialDropInterval);

    // Pause when tab is not visible
    document.addEventListener('visibilitychange', () => {
      isTabActive = !document.hidden;
      
      if (isTabActive) {
        startIntervals();
      } else {
        stopIntervals();
      }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      stopIntervals();
    });
  })();
</script>