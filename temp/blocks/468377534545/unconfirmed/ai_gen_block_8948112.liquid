{% doc %}
  @prompt
    i want a section like this: Delivery
    Enter Delivery Pincode
    Check Enter pincode
    Delivery by13 Nov, Thursday?
    if ordered before 4:33 PM
    instead of Enter pincode. I want Enter your city. and it should be for just Bangladesh. the UI should be like this : Border
    Border width
    
    1
    Border color
    
    #E0E0E0
    Hover border color
    
    #CCCCCC
    Border radius
    
    8
    Shadow
    Horizontal offset
    
    -7
    Vertical offset
    
    1
    Blur radius
    
    4
    Shadow opacity
    
    0
    , delivery and check text should be in center. and it should be workable , when i click check button it doesn't work, Delivery by text
    
    Delivery by
    Condition text. should be update in real time also for result i want real time delivery result , top and bottom padding should be customizable also inside Dhaka and outside Dhaka Delivery days can be customizable 
{% enddoc %}
{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .ai-delivery-checker-{{ ai_gen_id }} {
    padding: {{ block.settings.padding_top }}px {{ block.settings.padding_horizontal }}px {{ block.settings.padding_bottom }}px {{ block.settings.padding_horizontal }}px;
    background-color: {{ block.settings.background_color }};
    border-radius: {{ block.settings.container_border_radius }}px;
  }

  .ai-delivery-checker__title-{{ ai_gen_id }} {
    font-size: {{ block.settings.title_size }}px;
    font-weight: 600;
    color: {{ block.settings.title_color }};
    margin: 0 0 16px 0;
    text-align: center;
  }

  .ai-delivery-checker__input-wrapper-{{ ai_gen_id }} {
    position: relative;
    margin-bottom: 16px;
  }

  .ai-delivery-checker__input-{{ ai_gen_id }} {
    width: 100%;
    padding: 12px 16px;
    font-size: 14px;
    border: {{ block.settings.border_width }}px solid {{ block.settings.border_color }};
    border-radius: {{ block.settings.border_radius }}px;
    transition: border-color 0.3s ease;
    box-shadow: {{ block.settings.shadow_horizontal }}px {{ block.settings.shadow_vertical }}px {{ block.settings.shadow_blur }}px rgba(0, 0, 0, {{ block.settings.shadow_opacity }});
    text-align: center;
  }

  .ai-delivery-checker__input-{{ ai_gen_id }}::placeholder {
    text-align: center;
  }

  .ai-delivery-checker__input-{{ ai_gen_id }}:hover {
    border-color: {{ block.settings.hover_border_color }};
  }

  .ai-delivery-checker__input-{{ ai_gen_id }}:focus {
    outline: none;
    border-color: {{ block.settings.focus_border_color }};
  }

  .ai-delivery-checker__button-{{ ai_gen_id }} {
    width: 100%;
    padding: 12px 16px;
    background-color: {{ block.settings.button_background }};
    color: {{ block.settings.button_text_color }};
    border: none;
    border-radius: {{ block.settings.button_border_radius }}px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
    text-align: center;
  }

  .ai-delivery-checker__button-{{ ai_gen_id }}:hover {
    background-color: {{ block.settings.button_hover_background }};
  }

  .ai-delivery-checker__result-{{ ai_gen_id }} {
    margin-top: 16px;
    padding: 16px;
    background-color: {{ block.settings.result_background }};
    border-radius: {{ block.settings.border_radius }}px;
    border: 1px solid {{ block.settings.result_border_color }};
    display: none;
    text-align: center;
  }

  .ai-delivery-checker__result-{{ ai_gen_id }}.active {
    display: block;
  }

  .ai-delivery-checker__result-title-{{ ai_gen_id }} {
    font-size: 16px;
    font-weight: 600;
    color: {{ block.settings.result_title_color }};
    margin: 0 0 8px 0;
  }

  .ai-delivery-checker__result-text-{{ ai_gen_id }} {
    font-size: 14px;
    color: {{ block.settings.result_text_color }};
    margin: 0;
  }

  .ai-delivery-checker__result-date-{{ ai_gen_id }} {
    font-size: 18px;
    font-weight: 700;
    color: {{ block.settings.result_date_color }};
    margin: 8px 0;
  }

  .ai-delivery-checker__result-condition-{{ ai_gen_id }} {
    font-size: 12px;
    color: {{ block.settings.result_condition_color }};
    margin: 4px 0 0 0;
  }

  .ai-delivery-checker__error-{{ ai_gen_id }} {
    margin-top: 8px;
    padding: 12px;
    background-color: {{ block.settings.error_background }};
    border-radius: {{ block.settings.border_radius }}px;
    border: 1px solid {{ block.settings.error_border_color }};
    color: {{ block.settings.error_text_color }};
    font-size: 14px;
    display: none;
    text-align: center;
  }

  .ai-delivery-checker__error-{{ ai_gen_id }}.active {
    display: block;
  }
{% endstyle %}

<delivery-checker-{{ ai_gen_id }}
  class="ai-delivery-checker-{{ ai_gen_id }}"
  {{ block.shopify_attributes }}
  data-delivery-days-dhaka="{{ block.settings.delivery_days_dhaka }}"
  data-delivery-days-outside="{{ block.settings.delivery_days_outside }}"
  data-cutoff-hour="{{ block.settings.cutoff_hour }}"
  data-cutoff-minute="{{ block.settings.cutoff_minute }}"
  data-delivery-by-text="{{ block.settings.delivery_by_text }}"
  data-condition-text="{{ block.settings.condition_text }}"
  data-error-empty="{{ block.settings.error_empty }}"
  data-error-invalid="{{ block.settings.error_invalid }}"
>
  <h3 class="ai-delivery-checker__title-{{ ai_gen_id }}">{{ block.settings.title }}</h3>

  <div class="ai-delivery-checker__input-wrapper-{{ ai_gen_id }}">
    <input
      type="text"
      class="ai-delivery-checker__input-{{ ai_gen_id }}"
      placeholder="{{ block.settings.placeholder }}"
      aria-label="Enter your city"
      data-city-input
    >
  </div>

  <button
    type="button"
    class="ai-delivery-checker__button-{{ ai_gen_id }}"
    data-check-button
  >
    {{ block.settings.button_text }}
  </button>

  <div class="ai-delivery-checker__error-{{ ai_gen_id }}" data-error-message></div>

  <div class="ai-delivery-checker__result-{{ ai_gen_id }}" data-result>
    <p class="ai-delivery-checker__result-title-{{ ai_gen_id }}">{{ block.settings.result_title }}</p>
    <p class="ai-delivery-checker__result-date-{{ ai_gen_id }}" data-delivery-date></p>
    <p class="ai-delivery-checker__result-condition-{{ ai_gen_id }}" data-delivery-condition></p>
  </div>
</delivery-checker-{{ ai_gen_id }}>

<script>
  (function() {
    if (customElements.get('delivery-checker-{{ ai_gen_id }}')) {
      return;
    }

    class DeliveryChecker{{ ai_gen_id }} extends HTMLElement {
      constructor() {
        super();
        this.dhakaCities = ['dhaka', 'gazipur', 'narayanganj', 'tongi', 'savar', 'narsingdi'];
        this.bangladeshCities = [
          'dhaka', 'chittagong', 'khulna', 'rajshahi', 'sylhet', 'barisal', 'rangpur', 'mymensingh',
          'comilla', 'narayanganj', 'gazipur', 'tongi', 'narsingdi', 'savar', 'jessore', 'bogra',
          'dinajpur', 'cox\'s bazar', 'coxs bazar', 'pabna', 'kushtia', 'tangail', 'jamalpur', 'faridpur', 
          'brahmanbaria', 'sirajganj', 'madaripur', 'munshiganj', 'manikganj', 'gopalganj', 'shariatpur', 
          'kishoreganj', 'netrokona', 'sherpur', 'habiganj', 'moulvibazar', 'sunamganj', 'feni', 
          'lakshmipur', 'noakhali', 'chandpur', 'chuadanga', 'jhenaidah', 'magura', 'meherpur', 
          'narail', 'satkhira', 'bagerhat', 'jhalokati', 'patuakhali', 'pirojpur', 'bandarban', 
          'khagrachhari', 'rangamati', 'joypurhat', 'naogaon', 'natore', 'chapainawabganj', 
          'gaibandha', 'kurigram', 'lalmonirhat', 'nilphamari', 'panchagarh', 'thakurgaon'
        ];
        this.updateInterval = null;
        this.currentCity = '';
      }

      connectedCallback() {
        this.input = this.querySelector('[data-city-input]');
        this.button = this.querySelector('[data-check-button]');
        this.result = this.querySelector('[data-result]');
        this.error = this.querySelector('[data-error-message]');
        this.deliveryDate = this.querySelector('[data-delivery-date]');
        this.deliveryCondition = this.querySelector('[data-delivery-condition]');

        this.deliveryDaysDhaka = parseInt(this.dataset.deliveryDaysDhaka) || 3;
        this.deliveryDaysOutside = parseInt(this.dataset.deliveryDaysOutside) || 7;
        this.cutoffHour = parseInt(this.dataset.cutoffHour) || 16;
        this.cutoffMinute = parseInt(this.dataset.cutoffMinute) || 33;
        this.deliveryByText = this.dataset.deliveryByText || 'Delivery by';
        this.conditionText = this.dataset.conditionText || 'if ordered before';
        this.errorEmpty = this.dataset.errorEmpty || 'Please enter your city name';
        this.errorInvalid = this.dataset.errorInvalid || 'Sorry, we don\'t deliver to this city yet.';

        if (this.button) {
          this.button.addEventListener('click', () => this.checkDelivery());
        }

        if (this.input) {
          this.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              this.checkDelivery();
            }
          });
        }
      }

      disconnectedCallback() {
        if (this.updateInterval) {
          clearInterval(this.updateInterval);
        }
      }

      checkDelivery() {
        const city = this.input.value.trim();

        if (this.result) {
          this.result.classList.remove('active');
        }
        if (this.error) {
          this.error.classList.remove('active');
        }

        if (this.updateInterval) {
          clearInterval(this.updateInterval);
          this.updateInterval = null;
        }

        if (!city) {
          this.showError(this.errorEmpty);
          return;
        }

        const cityLower = city.toLowerCase();
        const isValidCity = this.bangladeshCities.includes(cityLower);

        if (!isValidCity) {
          this.showError(this.errorInvalid);
          return;
        }

        this.currentCity = cityLower;
        this.showDeliveryInfo();
        this.updateInterval = setInterval(() => {
          this.updateDeliveryInfo();
        }, 1000);
      }

      showError(message) {
        if (this.error) {
          this.error.textContent = message;
          this.error.classList.add('active');
        }
      }

      getBangladeshTime() {
        const now = new Date();
        const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
        const bangladeshTime = new Date(utcTime + (6 * 3600000));
        return bangladeshTime;
      }

      getDeliveryDays() {
        if (this.dhakaCities.includes(this.currentCity)) {
          return this.deliveryDaysDhaka;
        }
        return this.deliveryDaysOutside;
      }

      calculateDeliveryInfo() {
        const now = this.getBangladeshTime();
        
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const currentSecond = now.getSeconds();

        const deliveryDays = this.getDeliveryDays();

        let deliveryDate = new Date(now);
        const currentTime = currentHour * 60 + currentMinute;
        const cutoffTime = this.cutoffHour * 60 + this.cutoffMinute;

        if (currentTime >= cutoffTime) {
          deliveryDate.setDate(deliveryDate.getDate() + deliveryDays + 1);
        } else {
          deliveryDate.setDate(deliveryDate.getDate() + deliveryDays);
        }

        const options = { day: 'numeric', month: 'short', weekday: 'long' };
        const formattedDate = deliveryDate.toLocaleDateString('en-US', options);

        const cutoffHour12 = this.cutoffHour > 12 ? this.cutoffHour - 12 : (this.cutoffHour === 0 ? 12 : this.cutoffHour);
        const ampm = this.cutoffHour >= 12 ? 'PM' : 'AM';
        const cutoffTimeStr = cutoffHour12 + ':' + String(this.cutoffMinute).padStart(2, '0') + ' ' + ampm;

        const timeRemaining = cutoffTime - currentTime;
        const hoursRemaining = Math.floor(timeRemaining / 60);
        const minutesRemaining = timeRemaining % 60;
        const secondsRemaining = 60 - currentSecond;

        let conditionText = this.conditionText + ' ' + cutoffTimeStr;
        
        if (currentTime < cutoffTime) {
          const displayMinutes = secondsRemaining === 60 ? minutesRemaining : minutesRemaining - 1;
          const displaySeconds = secondsRemaining === 60 ? 0 : secondsRemaining;
          
          conditionText += ' (' + hoursRemaining + 'h ' + displayMinutes + 'm ' + displaySeconds + 's remaining)';
        }

        return {
          formattedDate: formattedDate,
          conditionText: conditionText
        };
      }

      showDeliveryInfo() {
        const info = this.calculateDeliveryInfo();

        if (this.deliveryDate) {
          this.deliveryDate.textContent = this.deliveryByText + ' ' + info.formattedDate;
        }
        if (this.deliveryCondition) {
          this.deliveryCondition.textContent = info.conditionText;
        }
        if (this.result) {
          this.result.classList.add('active');
        }
      }

      updateDeliveryInfo() {
        if (this.result && this.result.classList.contains('active')) {
          const info = this.calculateDeliveryInfo();
          
          if (this.deliveryDate) {
            this.deliveryDate.textContent = this.deliveryByText + ' ' + info.formattedDate;
          }
          if (this.deliveryCondition) {
            this.deliveryCondition.textContent = info.conditionText;
          }
        }
      }
    }

    customElements.define('delivery-checker-{{ ai_gen_id }}', DeliveryChecker{{ ai_gen_id }});
  })();
</script>

{% schema %}
{
  "name": "Delivery checker",
  "tag": null,
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Delivery"
    },
    {
      "type": "text",
      "id": "placeholder",
      "label": "Input placeholder",
      "default": "Enter your city"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Check"
    },
    {
      "type": "text",
      "id": "result_title",
      "label": "Result title",
      "default": "Delivery available"
    },
    {
      "type": "text",
      "id": "delivery_by_text",
      "label": "Delivery by text",
      "default": "Delivery by"
    },
    {
      "type": "text",
      "id": "condition_text",
      "label": "Condition text",
      "default": "if ordered before"
    },
    {
      "type": "header",
      "content": "Delivery settings"
    },
    {
      "type": "range",
      "id": "delivery_days_dhaka",
      "min": 1,
      "max": 14,
      "step": 1,
      "unit": "d",
      "label": "Delivery days (Inside Dhaka)",
      "default": 3
    },
    {
      "type": "range",
      "id": "delivery_days_outside",
      "min": 1,
      "max": 14,
      "step": 1,
      "unit": "d",
      "label": "Delivery days (Outside Dhaka)",
      "default": 7
    },
    {
      "type": "range",
      "id": "cutoff_hour",
      "min": 0,
      "max": 23,
      "step": 1,
      "unit": "h",
      "label": "Cutoff hour (24h format)",
      "default": 16
    },
    {
      "type": "range",
      "id": "cutoff_minute",
      "min": 0,
      "max": 59,
      "step": 1,
      "unit": "m",
      "label": "Cutoff minute",
      "default": 33
    },
    {
      "type": "header",
      "content": "Error messages"
    },
    {
      "type": "text",
      "id": "error_empty",
      "label": "Empty field error",
      "default": "Please enter your city name"
    },
    {
      "type": "text",
      "id": "error_invalid",
      "label": "Invalid city error",
      "default": "Sorry, we don't deliver to this city yet. Please enter a valid Bangladesh city."
    },
    {
      "type": "header",
      "content": "Border"
    },
    {
      "type": "range",
      "id": "border_width",
      "min": 0,
      "max": 5,
      "step": 1,
      "unit": "px",
      "label": "Border width",
      "default": 1
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border color",
      "default": "#E0E0E0"
    },
    {
      "type": "color",
      "id": "hover_border_color",
      "label": "Hover border color",
      "default": "#CCCCCC"
    },
    {
      "type": "color",
      "id": "focus_border_color",
      "label": "Focus border color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "border_radius",
      "min": 0,
      "max": 20,
      "step": 2,
      "unit": "px",
      "label": "Border radius",
      "default": 8
    },
    {
      "type": "header",
      "content": "Shadow"
    },
    {
      "type": "range",
      "id": "shadow_horizontal",
      "min": -20,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Horizontal offset",
      "default": -7
    },
    {
      "type": "range",
      "id": "shadow_vertical",
      "min": -20,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Vertical offset",
      "default": 1
    },
    {
      "type": "range",
      "id": "shadow_blur",
      "min": 0,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Blur radius",
      "default": 4
    },
    {
      "type": "range",
      "id": "shadow_opacity",
      "min": 0,
      "max": 1,
      "step": 0.1,
      "label": "Shadow opacity",
      "default": 0
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_background",
      "label": "Button background",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button text",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "button_hover_background",
      "label": "Button hover background",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "result_background",
      "label": "Result background",
      "default": "#F0F9FF"
    },
    {
      "type": "color",
      "id": "result_border_color",
      "label": "Result border",
      "default": "#BAE6FD"
    },
    {
      "type": "color",
      "id": "result_title_color",
      "label": "Result title",
      "default": "#0C4A6E"
    },
    {
      "type": "color",
      "id": "result_text_color",
      "label": "Result text",
      "default": "#075985"
    },
    {
      "type": "color",
      "id": "result_date_color",
      "label": "Result date",
      "default": "#0C4A6E"
    },
    {
      "type": "color",
      "id": "result_condition_color",
      "label": "Result condition",
      "default": "#0369A1"
    },
    {
      "type": "color",
      "id": "error_background",
      "label": "Error background",
      "default": "#FEF2F2"
    },
    {
      "type": "color",
      "id": "error_border_color",
      "label": "Error border",
      "default": "#FECACA"
    },
    {
      "type": "color",
      "id": "error_text_color",
      "label": "Error text",
      "default": "#991B1B"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Top padding",
      "default": 20
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Bottom padding",
      "default": 20
    },
    {
      "type": "range",
      "id": "padding_horizontal",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Horizontal padding",
      "default": 20
    },
    {
      "type": "range",
      "id": "container_border_radius",
      "min": 0,
      "max": 30,
      "step": 2,
      "unit": "px",
      "label": "Container border radius",
      "default": 8
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "min": 0,
      "max": 30,
      "step": 2,
      "unit": "px",
      "label": "Button border radius",
      "default": 8
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Title size",
      "default": 16
    }
  ],
  "presets": [
    {
      "name": "Delivery checker"
    }
  ]
}
{% endschema %}
